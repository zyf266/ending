# 网格策略增强说明

## ✅ 已完成的增强功能

### 1. 边界保护机制

#### 1.1 总亏损限制
- **触发条件**: 累计亏损超过总投资额的 50%
- **保护动作**: 自动停止策略，防止继续亏损
- **计算公式**: `总投资 = 单格投资 × 网格数量`
- **日志输出**: `⚠️ 【边界保护】总亏损超限`

#### 1.2 日内亏损限制
- **触发条件**: 单日已实现亏损超过总投资的 30%
- **保护动作**: 自动停止当日交易
- **自动重置**: 每天零点自动重置日内盈亏统计
- **日志输出**: `⚠️ 【边界保护】日内亏损超限`

#### 1.3 持仓价值限制
- **最大持仓**: `单格投资 × 网格数 × 2`
- **保护动作**: 超限时拒绝新开仓
- **日志输出**: `⚠️ 【边界保护】持仓价值将超限`

#### 1.4 方向保护（做多/做空网格）
- **long_only**: 严禁在当前价格上方挂买单
- **short_only**: 严禁在当前价格下方挂卖单
- **保护动作**: 跳过不符合逻辑的订单
- **日志输出**: `【网格】跳过价格上/下方的买/卖单`

---

### 2. 精细化利润统计

#### 2.1 实时盈亏追踪
- **已实现盈亏**: 每笔平仓后立即计算并累加
- **手续费统计**: 开仓 + 平仓双向手续费（默认 0.04% taker）
- **净利润计算**: `净利润 = 毛利 - 手续费`

#### 2.2 峰值与回撤
- **峰值利润**: 记录历史最高盈利点
- **最大回撤**: `最大回撤 = 峰值利润 - 当前利润`
- **动态更新**: 每笔平仓后自动更新

#### 2.3 持仓价值追踪
- **开仓时**: `持仓价值 += 开仓价 × 数量`
- **平仓时**: `持仓价值 -= 开仓价 × 数量`
- **用途**: 用于边界保护和风险控制

#### 2.4 日内盈亏隔离
- **每日重置**: 自动在新的一天清零
- **独立统计**: 不影响累计总盈亏
- **风控依据**: 用于日内止损判断

---

### 3. 增强的状态报告

#### 3.1 新增统计字段
```python
{
    # 原有字段
    'running': True/False,
    'current_price': 2430.50,
    'total_trades': 10,
    'total_profit': 125.30,
    'buy_count': 5,
    'sell_count': 5,
    'pending_orders': 8,
    'filled_orders': 2,
    'grid_levels': 10,
    
    # 【新增】详细统计
    'total_fees': 12.50,              # 累计手续费
    'unrealized_pnl': 0.0,            # 未实现盈亏（预留）
    'peak_profit': 150.00,            # 峰值利润
    'max_drawdown': 24.70,            # 最大回撤
    'current_position_value': 1250.00,# 当前持仓总价值
    'daily_realized_pnl': 35.20,     # 日内已实现盈亏
    'daily_loss_limit': 50.00,        # 日内亏损限制
    'max_position_size': 2000.00,     # 最大持仓限制
    'net_profit': 112.80,             # 净利润（扣除手续费）
    'win_rate': 0.65                  # 胜率（估算）
}
```

#### 3.2 实时日志输出
```
💰 【盈亏统计】平仓: BUY 开$2430.00 平$2440.00 | 单笔毛利: $10.00 | 手续费: $0.98 | 净利: $9.02
📊 【累计统计】总盈亏: $125.30 | 总手续费: $12.50 | 峰值: $150.00 | 最大回撤: $24.70 | 持仓: $1250.00
📅 【日内统计】已实现盈亏: $35.20 / 限制: $50.00
```

---

## 📊 使用示例

### 查看实时统计
```python
status = strategy.get_status()
print(f"总盈亏: ${status['total_profit']:.2f}")
print(f"净利润: ${status['net_profit']:.2f}")
print(f"最大回撤: ${status['max_drawdown']:.2f}")
print(f"日内盈亏: ${status['daily_realized_pnl']:.2f}")
```

### 自定义边界参数
```python
strategy.stop_loss_pct = 0.15  # 改为 15% 止损
strategy.daily_loss_limit = 100.0  # 改为日亏 $100 止损
strategy.max_position_size = 5000.0  # 改为最大持仓 $5000
```

---

## ⚙️ 技术实现细节

### 边界保护触发点
1. **下单前检查**: `_place_grid_order()` 开头
2. **监控循环中**: 每次价格更新后
3. **平仓后检查**: `_calculate_and_record_profit()` 结尾

### 利润计算公式
```
毛利（多单）= (平仓价 - 开仓价) × 数量
毛利（空单）= (开仓价 - 平仓价) × 数量
手续费 = (开仓价 × 数量 + 平仓价 × 数量) × 费率
净利润 = 毛利 - 手续费
```

### 数据持久化
- 所有统计数据存储在策略对象内存中
- 可通过 `get_status()` 随时查询
- 停止策略时数据不会丢失（在对象生命周期内）

---

## 🎯 后续优化建议

1. **数据库持久化**: 将盈亏记录保存到数据库，支持历史回溯
2. **图表可视化**: 在 Dash 前端显示盈亏曲线、回撤曲线
3. **动态调整**: 根据市场波动自动调整止损阈值
4. **推送通知**: 触发边界保护时发送钉钉/邮件告警
5. **未实现盈亏**: 实时计算当前持仓的浮动盈亏

---

## 📝 注意事项

1. **手续费率**: 默认使用 0.04% (Backpack taker)，如使用其他交易所需调整
2. **杠杆影响**: 当前未考虑杠杆对盈亏的放大效应（保证金模式）
3. **滑点影响**: 实际成交价可能与挂单价有偏差，影响利润计算精度
4. **跨日重置**: 日内盈亏在系统时区的零点重置，注意时区差异

---

## 🔧 测试建议

1. 先在小资金下运行，验证边界保护是否正常触发
2. 手动模拟大幅亏损，检查止损机制
3. 观察日志输出，确认利润计算的准确性
4. 对比交易所实际盈亏与系统统计值

---

**最后更新**: 2026-01-28  
**版本**: v2.0 - 边界保护 + 利润统计增强版
