# AI策略成本分析与优化方案

## 📊 当前配置（15分钟K线）

### 基础参数
- **K线周期**: 15分钟
- **分析频率**: 每15分钟触发一次（0/15/30/45分）
- **快速模式**: 50根K线 ≈ 12.5小时数据
- **深度模式**: 1000根K线 ≈ 10天数据
- **深度分析间隔**: 4小时触发一次

### Token消耗估算

#### 1. 快速模式（每15分钟）
```
输入Token:
- 50根K线数据: ~500 tokens
- 提示词: ~300 tokens
- 总输入: ~800 tokens

输出Token:
- AI分析报告: ~500-1000 tokens

单次成本: ~1300-1800 tokens
```

#### 2. 深度模式（每4小时）
```
输入Token:
- 1000根K线数据: ~10,000 tokens
- 提示词: ~300 tokens
- 总输入: ~10,300 tokens

输出Token:
- AI深度分析报告: ~1000-2000 tokens

单次成本: ~11,300-12,300 tokens
```

### 每日成本（24小时）

#### Token消耗:
```
快速模式: 96次 × 1,500 tokens = 144,000 tokens
深度模式: 6次 × 12,000 tokens = 72,000 tokens
每日总计: 216,000 tokens
```

#### 费用（DeepSeek V3定价）:
```
输入: $0.07 / 1M tokens
输出: $0.28 / 1M tokens

假设输入:输出 = 2:1
每日输入: 144,000 tokens = $0.01
每日输出: 72,000 tokens = $0.02
每日总成本: $0.03 /交易对/天
```

---

## 🚀 切换到1分钟K线的影响

### 基础参数
- **K线周期**: 1分钟
- **分析频率**: 每1分钟触发一次
- **快速模式**: 50根K线 ≈ 50分钟数据
- **深度模式**: 1000根K线 ≈ 16.7小时数据

### Token消耗估算

#### 方案A: 保持相同数据量
```
快速模式: 50根 × 1分钟 = 50分钟数据
深度模式: 1000根 × 1分钟 = 16.7小时数据

Token消耗: 与15分钟相同
分析频率: 每1分钟 = 1440次/天

每日Token: 216,000 × 1440/96 = 3,240,000 tokens
每日成本: $0.03 × 15 = $0.45 /交易对/天
```

#### 方案B: 调整数据量（推荐）
```
快速模式: 300根 × 1分钟 = 5小时数据 (≈ 原15分钟的20根)
深度模式: 2000根 × 1分钟 = 33小时数据

Token消耗:
- 快速: ~2,000 tokens/次
- 深度: ~15,000 tokens/次

触发频率优化:
- 快速模式: 每5分钟触发 (288次/天)
- 深度模式: 每4小时触发 (6次/天)

每日Token: 288 × 2,000 + 6 × 15,000 = 666,000 tokens
每日成本: ~$0.09 /交易对/天
```

---

## 💡 成本优化方案

### 方案1: 智能触发（推荐⭐）
```python
# 仅在价格波动>0.5%时触发AI分析
if abs(price_change) > 0.005:
    await ai_analyze()
```

**预期效果**:
- 减少无效分析70%
- 每日成本: $0.03 → $0.01

### 方案2: 梯度频率
```
震荡期: 每30分钟分析一次
趋势期: 每5分钟分析一次
快速期: 每1分钟分析一次
```

**预期效果**:
- 平均减少50%调用
- 每日成本: $0.09 → $0.045

### 方案3: 本地预筛选
```python
# 使用本地技术指标快速筛选
if local_filter_passed():
    await ai_deep_analyze()  # 仅深度机会调用AI
```

**预期效果**:
- 减少无效AI调用85%
- 每日成本: $0.09 → $0.014

### 方案4: 缓存复用
```python
# 相似K线模式使用缓存结果
if similar_pattern_exists():
    return cached_analysis
```

**预期效果**:
- 减少重复分析60%
- 每日成本: $0.09 → $0.036

---

## 📈 成本对比总结

| 配置方案 | 分析频率 | 每日Token | 每日成本 | 月成本 |
|---------|---------|----------|---------|--------|
| **当前（15分钟）** | 96次 | 216K | $0.03 | $0.90 |
| **1分钟-方案A** | 1440次 | 3.24M | $0.45 | $13.50 |
| **1分钟-方案B** | 288次 | 666K | $0.09 | $2.70 |
| **优化1: 智能触发** | ~60次 | 200K | $0.03 | $0.90 |
| **优化2: 梯度频率** | ~150次 | 333K | $0.045 | $1.35 |
| **优化3: 本地预筛选** | ~30次 | 100K | $0.014 | $0.42 |
| **优化4: 缓存复用** | ~120次 | 266K | $0.036 | $1.08 |

---

## 🎯 推荐配置

### 配置A: 平衡型（推荐）
```
- K线周期: 1分钟
- 数据量: 300根（快速）/ 2000根（深度）
- 触发策略: 智能触发（价格波动>0.5%）
- 分析频率: 动态（平均60次/天）
- 预计成本: $0.90/月/交易对
```

### 配置B: 高频型
```
- K线周期: 1分钟
- 数据量: 300根（快速）/ 2000根（深度）
- 触发策略: 每5分钟
- 分析频率: 288次/天
- 预计成本: $2.70/月/交易对
```

### 配置C: 经济型
```
- K线周期: 1分钟
- 数据量: 50根（快速）/ 1000根（深度）
- 触发策略: 本地预筛选
- 分析频率: ~30次/天
- 预计成本: $0.42/月/交易对
```

---

## 🔧 实施建议

1. **第一阶段**: 继续使用15分钟，验证策略有效性
2. **第二阶段**: 切换到1分钟+智能触发，观察成本
3. **第三阶段**: 根据实际效果调整触发策略
4. **长期优化**: 实现本地预筛选+缓存机制

---

## ⚠️ 注意事项

1. **DeepSeek API限制**:
   - 最大context: 131K tokens
   - 如果使用2000根1分钟K线，需控制在此范围内

2. **实时性 vs 成本**:
   - 1分钟K线提高响应速度
   - 但成本可能增加3-15倍

3. **策略适配**:
   - 1分钟K线适合高频策略
   - 15分钟K线适合波段策略

4. **当前问题**:
   - 去重机制导致重复跳过（已修复）
   - AI信号格式已统一为多空双向
